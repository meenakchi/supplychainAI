<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Supply Chain Risk Propagation Analyzer</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
</head>

<body class="bg-slate-50">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

/* ================= DATA ================= */
const companies = [
    'Nvidia','TSMC','Apple','Microsoft','Tesla','AMD','Google','Amazon','Intel',
    'Samsung','Foxconn','ASML','Panasonic','LG','CATL','Ford','GM','Qualcomm',
    'MediaTek','Sony','Dell','HP','Meta','ByteDance','Alibaba','Tencent',
    'SK_Hynix','Bosch','Denso'
];

const tickerMapping = {
    Nvidia:'NVDA', TSMC:'TSM', Apple:'AAPL', Microsoft:'MSFT',
    Tesla:'TSLA', AMD:'AMD', Google:'GOOGL', Amazon:'AMZN',
    Intel:'INTC', Samsung:'SSNLF', Meta:'META', Ford:'F',
    GM:'GM', Qualcomm:'QCOM', Sony:'SONY', Dell:'DELL',
    HP:'HPQ', Alibaba:'BABA', Tencent:'TCEHY'
};

const predefinedScenarios = [
    { name:'Taiwan Earthquake', description:'Major earthquake disrupts TSMC production', affected:['TSMC'], intensity:0.9, category:'Natural Disaster' },
    { name:'Lithium Supply Shock', description:'Battery material shortage drives cost inflation', affected:['Panasonic','LG','CATL','Samsung'], intensity:0.8, category:'Resource Constraint' },
    { name:'AI Chip Shortage', description:'Demand for AI accelerators exceeds supply', affected:['Nvidia'], intensity:0.7, category:'Demand Shock' },
    { name:'Rare Earth Export Controls', description:'Export restrictions impact semiconductor tooling', affected:['ASML','Samsung','SK_Hynix'], intensity:0.85, category:'Geopolitical' },
    { name:'Energy Supply Crisis', description:'Power instability affects chip fabrication', affected:['Samsung','TSMC','Intel','ASML'], intensity:0.75, category:'Energy' },
    { name:'Port Disruption', description:'Logistics bottlenecks delay manufacturing', affected:['Foxconn','Samsung','TSMC','Sony'], intensity:0.65, category:'Logistics' }
];

/* ================= SIMULATION LOGIC (UNCHANGED) ================= */
const simulateRiskPropagation = (affectedCompanies, intensity) => {
    const risks = {};
    const dependencies = {
        TSMC:['Apple','Nvidia','AMD','Qualcomm','MediaTek','Sony'],
        Nvidia:['Microsoft','Tesla','Google','Amazon','Dell','Meta','ByteDance','Alibaba','Tencent'],
        Samsung:['Apple','Tesla','Dell','HP'],
        Panasonic:['Tesla'],
        LG:['Tesla','GM','Ford'],
        CATL:['Tesla','Ford','GM'],
        ASML:['Intel','Samsung','TSMC'],
        Intel:['HP','Dell','Amazon'],
        Foxconn:['Apple','Dell','HP'],
        Apple:['Microsoft','Google'],
        AMD:['Microsoft','Sony','Meta']
    };

    companies.forEach(c => {
        if (affectedCompanies.includes(c)) {
            risks[c] = intensity;
        } else {
            let r = 0;
            affectedCompanies.forEach(a => {
                if (dependencies[a]?.includes(c)) r = Math.max(r, intensity * 0.7 * Math.random());
                if (dependencies[c]?.includes(a)) r = Math.max(r, intensity * 0.5 * Math.random());
            });
            risks[c] = Math.min(r * (0.7 + Math.random() * 0.6), 1);
        }
    });
    return risks;
};

const runMonteCarloSimulation = (affected, intensity, iterations = 1000) => {
    const results = companies.map(c => ({ company:c, risks:[] }));
    for (let i=0;i<iterations;i++){
        const r = simulateRiskPropagation(affected,intensity);
        results.forEach(res => res.risks.push(r[res.company]||0));
    }
    return results.map(res => {
        const sorted = [...res.risks].sort((a,b)=>a-b);
        const mean = res.risks.reduce((a,b)=>a+b,0)/iterations;
        return {
            company:res.company,
            mean,
            p5:sorted[Math.floor(iterations*0.05)],
            p50:sorted[Math.floor(iterations*0.5)],
            p95:sorted[Math.floor(iterations*0.95)]
        };
    });
};

/* ================= UI COMPONENTS ================= */

const RiskBadge = ({ score }) => {
    const styles = score>0.7 ? 'bg-red-100 text-red-700'
        : score>0.5 ? 'bg-orange-100 text-orange-700'
        : score>0.3 ? 'bg-yellow-100 text-yellow-700'
        : 'bg-green-100 text-green-700';

    const label = score>0.7?'Critical':score>0.5?'High':score>0.3?'Moderate':'Low';

    return <span className={`px-2 py-0.5 rounded text-xs font-medium ${styles}`}>{label}</span>;
};

const App = () => {
    const [selectedScenario,setSelectedScenario] = useState(null);
    const [riskScores,setRiskScores] = useState(null);
    const [activeTab,setActiveTab] = useState('scenarios');
    const [mcResults,setMcResults] = useState(null);
    const [loading,setLoading] = useState(false);

    const runScenario = s => {
        setSelectedScenario(s);
        setRiskScores(simulateRiskPropagation(s.affected,s.intensity));
        setMcResults(null);
    };

    const runMC = () => {
        setLoading(true);
        setTimeout(()=>{
            setMcResults(runMonteCarloSimulation(
                selectedScenario.affected,
                selectedScenario.intensity
            ));
            setLoading(false);
        },500);
    };

    const sorted = riskScores
        ? Object.entries(riskScores).sort((a,b)=>b[1]-a[1]).slice(0,10)
        : [];

    const grouped = predefinedScenarios.reduce((a,s)=>{
        a[s.category]=a[s.category]||[];
        a[s.category].push(s);
        return a;
    },{});

    return (
        <div className="max-w-7xl mx-auto px-6 py-10">
            <header className="mb-10">
                <h1 className="text-4xl font-semibold text-slate-800">
                    Supply Chain Risk Propagation
                </h1>
                <p className="text-slate-500 mt-2 max-w-2xl">
                    Scenario-based modeling of cascading supply chain disruptions using probabilistic simulation.
                </p>
            </header>

            <div className="flex gap-3 mb-8">
                {['scenarios','analysis'].map(t=>(
                    <button key={t}
                        onClick={()=>setActiveTab(t)}
                        className={`px-5 py-2 rounded-full text-sm font-medium
                        ${activeTab===t?'bg-slate-900 text-white':'bg-white border text-slate-600'}`}>
                        {t.charAt(0).toUpperCase()+t.slice(1)}
                    </button>
                ))}
            </div>

            {activeTab==='scenarios' && (
                <div className="grid md:grid-cols-2 gap-6">
                    {Object.entries(grouped).map(([cat,items])=>(
                        <div key={cat} className="bg-white rounded-xl border p-5">
                            <h3 className="text-sm font-semibold text-slate-500 mb-4">{cat}</h3>
                            <div className="space-y-3">
                                {items.map(s=>(
                                    <button key={s.name}
                                        onClick={()=>runScenario(s)}
                                        className="w-full text-left p-4 rounded-lg border hover:bg-slate-50">
                                        <div className="flex justify-between">
                                            <span className="font-medium text-slate-800">{s.name}</span>
                                            <span className="text-xs text-slate-500">{Math.round(s.intensity*100)}%</span>
                                        </div>
                                        <p className="text-sm text-slate-500 mt-1">{s.description}</p>
                                    </button>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            )}

            {activeTab==='analysis' && riskScores && (
                <div className="space-y-8">
                    <div className="bg-white rounded-xl border p-6">
                        <div className="flex justify-between mb-4">
                            <h2 className="font-semibold text-slate-800">Monte Carlo Simulation</h2>
                            <button onClick={runMC}
                                className="px-4 py-2 bg-slate-900 text-white rounded-md text-sm">
                                {loading?'Running...':'Run Simulation'}
                            </button>
                        </div>
                        {mcResults && (
                            <div className="grid md:grid-cols-2 gap-4">
                                {mcResults.slice(0,6).map(r=>(
                                    <div key={r.company} className="border rounded p-3">
                                        <div className="flex justify-between">
                                            <span className="font-medium">{r.company}</span>
                                            <RiskBadge score={r.mean} />
                                        </div>
                                        <p className="text-xs text-slate-500 mt-1">
                                            Mean Risk: {(r.mean*100).toFixed(1)}%
                                        </p>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    <div className="bg-white rounded-xl border p-6">
                        <h2 className="font-semibold text-slate-800 mb-4">Most Exposed Entities</h2>
                        <div className="space-y-2">
                            {sorted.map(([c,s],i)=>(
                                <div key={c} className="flex justify-between items-center p-2 border rounded">
                                    <span className="text-sm font-medium">
                                        {i+1}. {c} {tickerMapping[c] && <span className="text-xs text-slate-400">({tickerMapping[c]})</span>}
                                    </span>
                                    <div className="flex gap-3 items-center">
                                        <span className="text-sm">{(s*100).toFixed(1)}%</span>
                                        <RiskBadge score={s}/>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

ReactDOM.render(<App/>,document.getElementById('root'));
</script>
</body>
</html>
